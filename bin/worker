#!/usr/bin/env node
/**
 * Module dependencies.
 */

var throng = require('throng');
var os = require('os');

var helper = require('../helper');
var rabbit = require('../data/rabbit');

var Notif = require('../models/notif');

/** clustering **/
var WORKERS = helper.int(process.env.WORKER_CONCURRENCY) || os.cpus().length;
throng({
    workers: WORKERS,
    lifetime: Infinity
}, start);

function start(id) {
    console.log("Started worker " + id);

    /** consume the notifications **/
    rabbit.consume(function(data, ack) {
        Notif.setProcessed(data.id, function(id) {
            if(id) {
                ack();
            }
        });
    });
}