#!/usr/bin/env node
/**
 * Module dependencies.
 */

var throng = require('throng');
var os = require('os');
var jackrabbit = require('jackrabbit');
var helper = require('../helper');

/** get config env **/
var config = helper.config();

/** clustering **/
var WORKERS = helper.int(process.env.WORKER_CONCURRENCY) || os.cpus().length;
throng({
    workers: WORKERS,
    lifetime: Infinity
}, start);

function start(id) {

    console.log("Started worker " + id);

    var rabbit = config.use_env_variable ?
        jackrabbit(process.env[config.rabbit_url]) :
        jackrabbit(config.rabbit_url);

    var exchange = rabbit.default();
    var hello = exchange.queue({name: 'task_queue', durable: true});

    hello.consume(onGreet);

    function onGreet(data, ack) {
        console.log('Hello, ' + data.name + '!');
        ack();
    }
}